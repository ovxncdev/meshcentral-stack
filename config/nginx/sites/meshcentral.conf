# ==============================================================================
# MeshCentral Site Configuration
# ==============================================================================
# Reverse proxy configuration for MeshCentral with WebSocket support.
#
# IMPORTANT: Replace these placeholders before use:
#   - YOUR_DOMAIN.COM -> Your actual domain (e.g., support.example.com)
#   - Certificate paths -> Your actual SSL certificate paths
#
# For automated setup, use the setup script which processes templates.
# ==============================================================================

# ==============================================================================
# HTTP -> HTTPS Redirect
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    
    # CHANGE THIS: Your domain name
    server_name YOUR_DOMAIN.COM;
    
    # ACME challenge for Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }
    
    # Redirect all other HTTP to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ==============================================================================
# HTTPS Server - Main MeshCentral
# ==============================================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    
    # CHANGE THIS: Your domain name
    server_name YOUR_DOMAIN.COM;
    
    # ==========================================================================
    # SSL Certificates
    # ==========================================================================
    
    # CHANGE THESE: Path to your SSL certificates
    # Option 1: Let's Encrypt (recommended)
    ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN.COM/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN.COM/privkey.pem;
    
    # Option 2: Self-signed or custom certificate
    # ssl_certificate /etc/nginx/ssl/cert.pem;
    # ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # DH parameters for additional security (optional)
    # Generate with: openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
    # ssl_dhparam /etc/nginx/ssl/dhparam.pem;
    
    # ==========================================================================
    # Security Headers
    # ==========================================================================
    
    # HSTS (enable after confirming SSL works)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Content Security Policy (adjusted for MeshCentral)
    # MeshCentral needs 'unsafe-inline' and 'unsafe-eval' for its UI
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' wss://$server_name; frame-ancestors 'self';" always;
    
    # Other security headers (inherited from main config, but can override)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ==========================================================================
    # Logging
    # ==========================================================================
    
    access_log /var/log/nginx/meshcentral_access.log main;
    error_log /var/log/nginx/meshcentral_error.log warn;
    
    # ==========================================================================
    # Rate Limiting (DISABLED)
    # ==========================================================================
    
    # Rate limiting disabled by default to avoid 429 errors
    # Uncomment after confirming everything works
    # limit_conn addr 100;
    
    # ==========================================================================
    # Proxy Settings
    # ==========================================================================
    
    # Proxy buffer settings
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 300s;
    
    # ==========================================================================
    # Locations
    # ==========================================================================
    
    # Static assets - no rate limiting
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|mp3|wav)$ {
        proxy_pass http://meshcentral;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache static assets
        proxy_cache_valid 200 1h;
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
    
    # Customer Support Portal
    location /support {
        alias /var/www/support;
        index index.html;
        try_files $uri $uri/ /support/index.html;
    }
    
    # Support Package Downloads
    location /downloads {
        alias /var/www/downloads;
        autoindex off;
        
        # Force download for ZIP files
        location ~* \.zip$ {
            add_header Content-Disposition 'attachment; filename="support-package.zip"';
        }
    }
    
    # Admin Dashboard
    # Admin Dashboard API (must come before general admin-settings)
    location ^~ /admin-settings/api/ {
        proxy_pass http://admin:3001/api/;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Admin Dashboard Static Files & UI
    location ^~ /admin-settings/ {
        proxy_pass http://admin:3001/;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /admin-settings;
    }
    
    # Admin Dashboard root redirect
    location = /admin-settings {
        return 301 /admin-settings/;
    }
    
    # Main MeshCentral application
    location / {
        proxy_pass http://meshcentral;
        
        # Standard proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket support (required for MeshCentral)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # Disable buffering for real-time communication
        proxy_buffering off;
        proxy_cache off;
        
        # Large file support (for file transfers)
        client_max_body_size 100M;
    }
    
    # MeshCentral agent downloads
    location /meshagents {
        proxy_pass http://meshcentral;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Allow caching of agent downloads
        proxy_cache_valid 200 1h;
    }
    
    # MeshCentral API (if used)
    location /api/ {
        # Rate limit disabled - uncomment after setup works
        # limit_req zone=api burst=50 nodelay;
        
        proxy_pass http://meshcentral;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Login page
    location /login {
        # Rate limit disabled - uncomment after setup works
        # limit_req zone=auth burst=5 nodelay;
        
        proxy_pass http://meshcentral;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Block sensitive paths
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # Block access to backup files
    location ~ ~$ {
        deny all;
        return 404;
    }
}

# ==============================================================================
# Optional: Monitoring Subdomain (Uptime Kuma)
# ==============================================================================
# Uncomment if using Uptime Kuma on a subdomain
#
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     
#     server_name status.YOUR_DOMAIN.COM;
#     
#     ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN.COM/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN.COM/privkey.pem;
#     
#     # HSTS
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     
#     location / {
#         proxy_pass http://uptime-kuma;
#         
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         # WebSocket support
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection $connection_upgrade;
#     }
# }

# ==============================================================================
# Optional: Logs Subdomain (Dozzle)
# ==============================================================================
# Uncomment if using Dozzle on a subdomain
# WARNING: Protect with authentication - exposes container logs!
#
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     
#     server_name logs.YOUR_DOMAIN.COM;
#     
#     ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN.COM/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN.COM/privkey.pem;
#     
#     # HSTS
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     
#     # Basic auth (generate with: htpasswd -c /etc/nginx/.htpasswd admin)
#     auth_basic "Restricted Access";
#     auth_basic_user_file /etc/nginx/.htpasswd;
#     
#     # IP whitelist (optional - add your IPs)
#     # allow 192.168.1.0/24;
#     # allow YOUR_IP;
#     # deny all;
#     
#     location / {
#         proxy_pass http://dozzle;
#         
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         
#         # WebSocket support
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection $connection_upgrade;
#     }
# }
