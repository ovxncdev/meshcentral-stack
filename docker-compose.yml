# ==============================================================================
# Docker Compose - Remote Support Stack
# ==============================================================================
# All configuration via .env file - nothing hardcoded here.
#
# Services:
#   - meshcentral: Remote support server
#   - nginx: Reverse proxy with SSL
#   - uptime-kuma: Monitoring dashboard
#   - dozzle: Docker log viewer
#
# Usage:
#   cp .env.example .env
#   # Edit .env with your settings
#   docker compose up -d
#
# ==============================================================================

services:
  # ============================================================================
  # MeshCentral - Core Remote Support
  # ============================================================================
  meshcentral:
    image: ghcr.io/ylianst/meshcentral:${MESHCENTRAL_VERSION:-latest}
    container_name: ${PROJECT_NAME:-remote-support}-meshcentral
    restart: unless-stopped
    
    # DNS fallback for code signing timestamps
    dns:
      - 8.8.8.8
      - 1.1.1.1
    
    environment:
      - NODE_ENV=${ENVIRONMENT:-production}
      - HOSTNAME=${SERVER_DOMAIN:-localhost}
      - REVERSE_PROXY=${MESHCENTRAL_REVERSE_PROXY:-nginx}
      - REVERSE_PROXY_TLS_PORT=${MESHCENTRAL_HTTPS_PORT:-443}
      - IFRAME=${MESHCENTRAL_ALLOW_IFRAME:-false}
      - ALLOW_NEW_ACCOUNTS=${MESHCENTRAL_NEW_ACCOUNTS:-false}
      - WEBRTC=${MESHCENTRAL_WEBRTC:-false}
      - ALLOWPLUGINS=${MESHCENTRAL_PLUGINS:-false}
      - LOCALSESSIONRECORDING=${MESHCENTRAL_SESSION_RECORDING:-true}
      - MINIFY=${MESHCENTRAL_MINIFY:-true}
      - TZ=${TZ:-UTC}
    
    volumes:
      # Data persistence
      - meshcentral_data:/opt/meshcentral/meshcentral-data
      - meshcentral_files:/opt/meshcentral/meshcentral-files
      - meshcentral_backups:/opt/meshcentral/meshcentral-backups
      
      # Custom config (optional - mounted read-only)
      - ${CONFIG_PATH:-./config}/meshcentral/config.json:/opt/meshcentral/meshcentral-data/config.json:ro
      
      # SSL certificate - shared with nginx so agent cert hash matches
      - ${SSL_CERT_PATH:-./data/ssl}/cert.pem:/opt/meshcentral/meshcentral-data/webserver-cert-public.crt:ro
      - ${SSL_CERT_PATH:-./data/ssl}/key.pem:/opt/meshcentral/meshcentral-data/webserver-cert-private.key:ro
    
    networks:
      - internal
    
    # No ports exposed directly - nginx handles external access
    expose:
      - "80"
      - "443"
    
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-5}
    
    deploy:
      resources:
        limits:
          memory: ${MESHCENTRAL_MEMORY_LIMIT:-512M}
        reservations:
          memory: ${MESHCENTRAL_MEMORY_RESERVATION:-256M}

  # ============================================================================
  # Nginx - Reverse Proxy & SSL Termination
  # ============================================================================
  nginx:
    image: nginx:${NGINX_VERSION:-alpine}
    container_name: ${PROJECT_NAME:-remote-support}-nginx
    restart: unless-stopped
    
    depends_on:
      meshcentral:
        condition: service_started
    
    environment:
      - TZ=${TZ:-UTC}
    
    volumes:
      # Nginx configuration
      - ${CONFIG_PATH:-./config}/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${CONFIG_PATH:-./config}/nginx/sites:/etc/nginx/sites:ro
      - ${CONFIG_PATH:-./config}/nginx/snippets:/etc/nginx/snippets:ro
      
      # SSL certificates
      - ${SSL_CERT_PATH:-./data/ssl}:/etc/nginx/ssl:ro
      - letsencrypt_data:/etc/letsencrypt:ro
      
      # Web root (for ACME challenges and custom portal)
      - ${WEB_PATH:-./web}:/var/www/html:ro
      
      # Support portal and downloads
      - ${WEB_PATH:-./web}/support:/var/www/support:ro
      - ${WEB_PATH:-./web}/downloads:/var/www/downloads:ro
      
      # Logs
      - nginx_logs:/var/log/nginx
    
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    
    networks:
      - internal
      - external
    
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-5}
    
    deploy:
      resources:
        limits:
          memory: ${NGINX_MEMORY_LIMIT:-128M}
        reservations:
          memory: ${NGINX_MEMORY_RESERVATION:-64M}

  # ============================================================================
  # Admin Dashboard - Settings & Configuration UI
  # ============================================================================
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-remote-support}-admin
    restart: unless-stopped
    
    # Run as root to avoid volume permission issues
    user: "0:0"
    
    # DNS for external API calls (Telegram, etc.)
    dns:
      - 8.8.8.8
      - 1.1.1.1
    
    environment:
      - NODE_ENV=${ENVIRONMENT:-production}
      - PORT=${ADMIN_PORT:-3001}
      - DATA_PATH=/app/data
      - AUTH_SECRET=${ADMIN_AUTH_SECRET:-}
      - TZ=${TZ:-UTC}
    
    volumes:
      # Persistent settings storage
      - ${DATA_PATH:-./data}/admin:/app/data
    
    networks:
      - internal
      - external
    
    expose:
      - "${ADMIN_PORT:-3001}"
    
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:${ADMIN_PORT:-3001}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-3}
    
    deploy:
      resources:
        limits:
          memory: ${ADMIN_MEMORY_LIMIT:-128M}
        reservations:
          memory: ${ADMIN_MEMORY_RESERVATION:-64M}

  # ============================================================================
  # Notification Service - Telegram/Webhook Notifications
  # ============================================================================
  notifications:
    build:
      context: ./services/notifications
      dockerfile: Dockerfile
    container_name: ${PROJECT_NAME:-remote-support}-notifications
    restart: unless-stopped
    
    environment:
      - NOTIFY_PORT=3000
      - TELEGRAM_ENABLED=${TELEGRAM_ENABLED:-false}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - NOTIFY_DEVICE_CONNECT=${NOTIFY_DEVICE_CONNECT:-true}
      - NOTIFY_DEVICE_DISCONNECT=${NOTIFY_DEVICE_DISCONNECT:-true}
      - NOTIFY_USER_LOGIN=${NOTIFY_USER_LOGIN:-false}
      - NOTIFY_USER_LOGOUT=${NOTIFY_USER_LOGOUT:-false}
      - TZ=${TZ:-UTC}
    
    networks:
      - internal
    
    expose:
      - "3000"
    
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-3}

  # ============================================================================
  # Certbot - Let's Encrypt SSL
  # ============================================================================
  certbot:
    image: certbot/certbot:${CERTBOT_VERSION:-latest}
    container_name: ${PROJECT_NAME:-remote-support}-certbot
    
    # Only run when needed (not always running)
    profiles:
      - ssl
    
    volumes:
      - letsencrypt_data:/etc/letsencrypt
      - ${WEB_PATH:-./web}/.well-known:/var/www/html/.well-known
    
    # Default: certificate renewal check
    command: renew --webroot --webroot-path=/var/www/html --quiet
    
    networks:
      - external

  # ============================================================================
  # Uptime Kuma - Monitoring Dashboard
  # ============================================================================
  uptime-kuma:
    image: louislam/uptime-kuma:${UPTIME_KUMA_VERSION:-1}
    container_name: ${PROJECT_NAME:-remote-support}-uptime-kuma
    restart: unless-stopped
    
    # Only if monitoring enabled
    profiles:
      - monitoring
      - full
    
    environment:
      - TZ=${TZ:-UTC}
    
    volumes:
      - uptime_kuma_data:/app/data
    
    networks:
      - internal
    
    expose:
      - "3001"
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-5}
    
    deploy:
      resources:
        limits:
          memory: ${UPTIME_KUMA_MEMORY_LIMIT:-256M}
        reservations:
          memory: ${UPTIME_KUMA_MEMORY_RESERVATION:-128M}

  # ============================================================================
  # Dozzle - Docker Log Viewer
  # ============================================================================
  dozzle:
    image: amir20/dozzle:${DOZZLE_VERSION:-latest}
    container_name: ${PROJECT_NAME:-remote-support}-dozzle
    restart: unless-stopped
    
    # Only if monitoring enabled
    profiles:
      - monitoring
      - full
    
    environment:
      - DOZZLE_LEVEL=${LOG_LEVEL:-info}
      - DOZZLE_NO_ANALYTICS=true
      - DOZZLE_AUTH_PROVIDER=${DOZZLE_AUTH_PROVIDER:-none}
      - TZ=${TZ:-UTC}
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
    networks:
      - internal
    
    expose:
      - "8080"
    
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-5}
    
    deploy:
      resources:
        limits:
          memory: ${DOZZLE_MEMORY_LIMIT:-128M}
        reservations:
          memory: ${DOZZLE_MEMORY_RESERVATION:-64M}

  # ============================================================================
  # Fail2Ban - Brute Force Protection
  # ============================================================================
  fail2ban:
    image: crazymax/fail2ban:${FAIL2BAN_VERSION:-latest}
    container_name: ${PROJECT_NAME:-remote-support}-fail2ban
    restart: unless-stopped
    
    # Only if security hardening enabled
    profiles:
      - security
      - full
    
    environment:
      - TZ=${TZ:-UTC}
      - F2B_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - F2B_DB_PURGE_AGE=${FAIL2BAN_DB_PURGE_AGE:-1d}
    
    volumes:
      # Fail2ban config and data
      - ${CONFIG_PATH:-./config}/fail2ban:/etc/fail2ban:ro
      - fail2ban_data:/var/lib/fail2ban
      
      # Logs to monitor
      - nginx_logs:/var/log/nginx:ro
    
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-10m}
        max-file: ${LOG_MAX_FILES:-5}
    
    deploy:
      resources:
        limits:
          memory: ${FAIL2BAN_MEMORY_LIMIT:-128M}
        reservations:
          memory: ${FAIL2BAN_MEMORY_RESERVATION:-64M}

# ==============================================================================
# Networks
# ==============================================================================
networks:
  # Internal network - containers only
  internal:
    name: ${PROJECT_NAME:-remote-support}_internal
    driver: bridge
    internal: true
  
  # External network - internet access
  external:
    name: ${PROJECT_NAME:-remote-support}_external
    driver: bridge

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  # MeshCentral data
  meshcentral_data:
    name: ${PROJECT_NAME:-remote-support}_meshcentral_data
  
  meshcentral_files:
    name: ${PROJECT_NAME:-remote-support}_meshcentral_files
  
  meshcentral_backups:
    name: ${PROJECT_NAME:-remote-support}_meshcentral_backups
  
  # SSL certificates
  letsencrypt_data:
    name: ${PROJECT_NAME:-remote-support}_letsencrypt
  
  # Nginx logs (shared with fail2ban)
  nginx_logs:
    name: ${PROJECT_NAME:-remote-support}_nginx_logs
  
  # Monitoring data
  uptime_kuma_data:
    name: ${PROJECT_NAME:-remote-support}_uptime_kuma
  
  # Fail2ban database
  fail2ban_data:
    name: ${PROJECT_NAME:-remote-support}_fail2ban
